<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: resources/final/middlewares.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: resources/final/middlewares.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const { body, validationResult } = require('express-validator/check')
const Partial = require('../partial/schema')
const {
    isCpfValid,
    sanitizecpf,
    validatorPhone,
    existsOldProposal,
    isBirthdateValid
} = require('../../utils')

/**
 * Export resource final middlewares
 * @memberof module:resources/final
 */
module.exports = (model) => {

    const validadeItemsPost = () => [
        body('productId', 'productId doesn\'t exists or not a number')
            .exists().isNumeric().withMessage('productId must be a number'),

        body('name', 'Name doesn\'t exists').exists(),

        body('email', 'Invalid email').exists().isEmail().normalizeEmail(),

        body('cpf', 'Invalid cpf')
            .exists()
            .customSanitizer(sanitizecpf)
            .custom(isCpfValid),

        body('birthdate')
            .exists().withMessage('Birthdate is necessary')
            .custom(isBirthdateValid)
            .withMessage('Invalid age, you must be between 18 and 65 years old'),

        body('phone')
            .exists().withMessage('Phone number is necessary')
            .custom(validatorPhone).withMessage('Phone number incorrect')
    ]

    const validation = (req, res, next) => {
        const errors = validationResult(req)
        if (!errors.isEmpty()) {
            return res.status(422).json({ errors: errors.array() })
        }
        next()
    }

    const validateProposal = async (req, res, next) => {
        const exists_old_proposal = await existsOldProposal(req.body.cpf, model)

        if (exists_old_proposal) {
            return res.status(400).json({
                erros: {
                    params: [],
                    messages: ['After a request, a same CPF can not have a new proposal for 90 days']
                }
            })
        } else {
            next()
        }
    }

    const removePartial = async (req, res, next) => {
        const { cpf } = req.body
        await Partial.remove({ cpf }).exec()
        next()
    }

    return {
        validationResult,
        find: [],
        post: [validateProposal, validadeItemsPost(), validation, removePartial],
        get: [],
        put: [],
        delete: []
    }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-database.html">database</a></li><li><a href="module-lib.html">lib</a></li><li><a href="module-resources.html">resources</a></li><li><a href="module-resources_final.html">resources/final</a></li><li><a href="module-resources_partial.html">resources/partial</a></li><li><a href="module-utils.html">utils</a></li></ul><h3>Classes</h3><ul><li><a href="module-lib.Controller.html">Controller</a></li><li><a href="module-lib.Dal.html">Dal</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Apr 23 2019 09:53:09 GMT-0300 (GMT-03:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
